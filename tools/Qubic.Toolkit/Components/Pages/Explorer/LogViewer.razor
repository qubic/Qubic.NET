@page "/explorer/logs"
@inject ToolkitBackendService Backend

<h4>Log Viewer</h4>
<p class="text-muted">View contract logs by contract index and log ID range. (Bob only)</p>

<div class="row mb-3">
    <div class="col-md-8">
        <div class="row g-2">
            <div class="col-3">
                <label class="form-label-sm">Contract Index</label>
                <input type="number" class="form-control form-control-sm" @bind="_contractIndex" />
            </div>
            <div class="col-3">
                <label class="form-label-sm">Start Log ID (optional)</label>
                <input type="number" class="form-control form-control-sm" @bind="_startLogId" />
            </div>
            <div class="col-3">
                <label class="form-label-sm">End Log ID (optional)</label>
                <input type="number" class="form-control form-control-sm" @bind="_endLogId" />
            </div>
            <div class="col-3 d-flex align-items-end">
                <button class="btn btn-primary btn-sm" @onclick="Lookup" disabled="@_loading">
                    @(_loading ? "Loading..." : "Fetch Logs")
                </button>
            </div>
        </div>
    </div>
</div>

@if (_error != null)
{
    <div class="alert alert-danger">@_error</div>
}

@if (_logs != null)
{
    <div class="card">
        <div class="card-header">Logs (@_logs.Count)</div>
        <div class="card-body" style="max-height:600px; overflow-y:auto">
            @if (_logs.Count == 0)
            {
                <span class="text-muted">No logs found.</span>
            }
            else
            {
                <table class="table table-sm table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Log ID</th>
                            <th>Tick</th>
                            <th>Contract</th>
                            <th>Event Type</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in _logs)
                        {
                            <tr>
                                <td class="mono">@log.LogId</td>
                                <td class="mono">@log.Tick</td>
                                <td>@log.ContractIndex</td>
                                <td>@log.EventType</td>
                                <td class="mono small" style="max-width:400px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap"
                                    title="@log.Data">@(log.Data ?? "")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
}

@code {
    private int _contractIndex;
    private long? _startLogId;
    private long? _endLogId;
    private List<Qubic.Bob.Models.BobLogEntry>? _logs;
    private bool _loading;
    private string? _error;

    private async Task Lookup()
    {
        _loading = true;
        _error = null;
        _logs = null;

        try
        {
            _logs = await Backend.GetLogsAsync(_contractIndex, _startLogId, _endLogId);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
